---
title: 并发编程如何保证原子性、有序性和可见性？
date: 2020-04-17 01:14
permalink: /pages/b23eb2/
categories:
  - 技术
  - 开发
tags:
  - 高并发
  - 原子性
---

# 并发编程如何保证原子性、有序性和可见性？

并发编程有三个至关重要的特性，即原子性、有序性、可见性。但我们要如何保证编写的程序满足这三大特性？

<!-- more -->

## 原子性
原子性指的是在一次或者多次操作中，要么所有的操作全部执行成功，要么全部失败不执行，不能因为有外部干扰而导致只有部分操作完成。典型的场景：
- 银行转账：一个账户做减操作，一个账户做加操作，必须要保证原子性。
- 赋值：int i = 1；符合原子性。

`volatile关键字并不保证数据的原子性，但synchronize关键字保证，jdk1.5及其后版本斑提供的原子类型变量保证原子性。`

## 可见性
可见性指的是多线程场景下，当一个线程对共享变量做出修改，那么另外的线程可以立即看到修改后的最新值。


## 有序性
有序性指的是代码在执行过程中的先后顺序。Java编译器会对我们编写的代码，在执行或者编译期间优化，但是必须保证优化后的代码，不影响程序的执行结果。比如：
```Java
int i = 10;
int b = i;
i++;
// more code ···
```
Java编译器不管怎么优化，都必须保证b=i的赋值，在i++执行之前，否则程序执行结果将不符合预期。

## JVM的作用

### JVM不完全保证原子性
我们知道，Java程序是运行在JVM中的，JVM定义了Java程序运行的规则。在Java语言中，基本的赋值操作都具备原子性。但是JMM（Java内存模型）只保证基本读取赋值操作的原子性。对于代码片段，可以考虑synchronize关键字或者jdk提供的原子类型。

### Java提供三种方式能保证可见性
- volatile关键字
  当一个变量被volatile修饰的时候，对于共享变量的读操作会直接在主内存中进行，而写操作虽然是在工作内存中进行，但是会立即同步至主内存。

- synchronize关键字
  synchronize很好理解，因为它能保证同一时刻只有一个线程能获取到锁，然后执行同步方法，并且还会保证将修改后的值刷新至主内存后再释放锁。

- JUC高并发包中显示锁Lock，具备和synchronize一样的功能；

`Lock和synchronize虽然都能保证可见性，因为加锁实现同一资源的顺序访问，但两者用法并不一样，此处不做详细描述`

### JVM部分保证有序性

Java内存模型允许编译器和处理器对指令进行重排序，但只能保证单线程情况这种优化对程序运行结果无影响。在多线程情况下需要做特殊处理，volatile、synchronize关键字和Lock显示锁都能实现。

还有就是能满足happes-before原则，则具备天然的有序性。


